environment:
  - IMPORT_PATH=github.com/efritz/ijci
  - WORKSPACE=/go/src/${IMPORT_PATH}
  - GO_IMAGE=golang:1.11
  - SKIP_MIGRATE=

workspace: ${WORKSPACE}

import:
  files: '*'

export:
  files:
    - vendor
    - ijci-api
    - ijci-agent
    - ijci-migrate

tasks:
  install-vendors:
    image: ${GO_IMAGE}
    script: |
      if [ ! -d vendor ]; then
        echo "Installing vendors"
        go get -u github.com/golang/dep/cmd/dep
        dep ensure
      fi

  go-build:
    image: ${GO_IMAGE}
    script: |
      echo "Building ${APP_NAME} binary"
      go build -o ijci-${APP_NAME} ./cmd/${APP_NAME}
    environment:
      - GOOS=linux
      - GOARCH=amd64
      - CGO_ENABLED=0

  build-image:
    type: build
    dockerfile: Dockerfile.${APP_NAME}
    tags:
      - ijci-${APP_NAME}:master-latest

plans:
  build:
    stages:
      - name: deps
        tasks:
          - install-vendors
      - name: build
        tasks:
          - name: go-build
            environment: APP_NAME=api
          - name: go-build
            environment: APP_NAME=agent
          - name: go-build
            environment: APP_NAME=migrate
            disabled: ${SKIP_MIGRATE}
        parallel: true

  build-images:
    stages:
      - name: build images
        tasks:
          - name: build-image
            environment: APP_NAME=api
          - name: build-image
            environment: APP_NAME=agent
          - name: build-image
            environment: APP_NAME=migrate
        parallel: true

metaplans:
  default:
    - build
    - build-images
